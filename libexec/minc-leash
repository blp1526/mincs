#!/bin/sh
# minc-leash: MINC least capability shell
#
# Copyright (C) 2015 Masami Hiramatsu <masami.hiramatsu@gmail.com>
# This program is released under the MIT License, see LICENSE.

set -e
test "$MINC_DEBUG" && set -x

# wash : wash up the given environment variables
wash() { # pattern
  for i in `env | grep $1 | cut -f 1 -d=`; do
    unset $i
  done
}

leash() { # rootdir [commands]
  RD=$1
  shift 1
  if [ "$MINC_DROPCAPS" ]; then
    :
    : 'If we need to drop capabilities, use capsh to run given command'
    if [ "$MINC_USERSPEC" ]; then
      : 'Setup userspec option'
      OPT=`echo $MINC_USERSPEC | \
        awk 'BEGIN{FS=":"} {if (NF==2) print "--gid="$2; print "--uid="$1}'`
    fi
    [ "$CAPSH_EXEC" ] && OPT="$OPT --exec"
    RUN="$MINC_DEBUG_PREFIX capsh --chroot=$RD $OPT --drop=$MINC_DROPCAPS -- "
    if [ -z "$CAPSH_EXEC" ]; then
      : 'If capsh does not support --exec, run it with sh -c '
      wash "^MINC_"
      exec $RUN -c "exec $*"
    fi
  else
    :
    : 'No capability change. Use chroot to run given command in a container'
    test "$MINC_USERSPEC" && OPT="--userspec $MINC_USERSPEC"
    RUN="$MINC_DEBUG_PREFIX chroot $OPT $RD"
  fi
  : 'Wash out the environment variables for MINCS'
  wash "^MINC_"
  : 'Execute given command'
  exec $RUN $@
}

if [ `basename $0` = "minc-leash" ]; then
  leash $@
fi
