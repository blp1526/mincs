#!/bin/sh
# minc-leash: MINC least capability shell
#
# Copyright (C) 2015 Masami Hiramatsu <masami.hiramatsu@gmail.com>
# This program is released under the MIT License, see LICENSE.

set -e
test "$MINC_DEBUG" && set -x

# wash : wash up the given environment variables
wash() {
pattern=$1
shift 1
for i in `env | grep $pattern | cut -f 1 -d=`; do
  unset $i
done
}

leash() {
RD=$1
shift 1
if [ "$MINC_DROPCAPS" ]; then
  if [ "$MINC_USERSPEC" ]; then
    OPT=`echo $MINC_USERSPEC | \
    awk 'BEGIN{FS=":"} {if (NF==2) print "--gid="$2; print "--uid="$1}'`
  fi
  [ "$CAPSH_EXEC" ] && OPT="$OPT --exec"
  RUN="$MINC_DEBUG_PREFIX capsh --chroot=$RD $OPT --drop=$MINC_DROPCAPS -- "
  if [ -z "$CAPSH_EXEC" ]; then
    wash "^MINC_"
    exec $RUN -c "exec $*"
  fi
else
  test "$MINC_USERSPEC" && OPT="--userspec $MINC_USERSPEC"
  RUN="$MINC_DEBUG_PREFIX chroot $OPT $RD"
fi
wash "^MINC_"
exec $RUN "$@"
}

if [ `basename $0` = "minc-leash" ]; then
  leash $@
fi
