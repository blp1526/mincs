#!/bin/sh
# minc-coat: MINC-container overlay attendant
#
# Copyright (C) 2015 Masami Hiramatsu <masami.hiramatsu@gmail.com>
# This program is released under the MIT License, see LICENSE.

set -e
set -u

# usage: minc-coat TMPDIR BASEDIR
TMPDIR=$1
BASEDIR=$2

# Check parameters
test -d $TMPDIR
test -d $BASEDIR

RD=$TMPDIR/root
UD=$TMPDIR/storage
WD=$TMPDIR/work
# Make working sub-directories
mkdir -p $RD $UD $WD

# Prepare overlayed root directory
# This is for upstreamed overlayfs
mount -t overlay -o upperdir=$UD,lowerdir=$BASEDIR,workdir=$WD overlayfs $RD 2>/dev/null || \
  # Workaround for ubuntu 14.10 (out-of-tree overlayfs)
  mount -t overlayfs -o upperdir=$UD,lowerdir=$BASEDIR overlayfs $RD
echo "umount $RD"
